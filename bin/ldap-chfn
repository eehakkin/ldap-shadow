#! /bin/sh -Cefu
###########################################################################
# ldap-chfn 1.0
#
# Copyright (C) 2012 Eero Häkkinen <Eero+ldap-shadow@Häkkinen.fi>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
###########################################################################
unfold() { exec sed -e ': in' -e 'N' -e 's/\n //' -e 't in' -e 'P' -e 'D'; }
case ${1-} in
--help=man        ) exec "${0}" --help=troff | exec man -l -- -; exit ;;
--help=troff      ) exec help2man -L 'en_US.UTF-8' -N -s 1 -- "${0}" ;;
--help=* | --help ) exec cat << __USAGE__ ;;
Usage: ${0##*[\\/]} [OPTIONS] [USER]

Change the full name, the home, mobile and work phone numbers and the room
number of an LDAP user account on an LDAP server. Whether a normal user may
change all, some or none of these for her own LDAP user account without
administrative privileges depends on access control configuration on the LDAP server being used.

Options:
 -f, --full-name COMMENT    Change the full name of the account.
     --help[=FORMAT]        Show this help message and exit.
 -h, --home-phone HOME      Change the home phone number of the account.
 -m, --mobile-phone MOBILE  Change the mobile phone number of the account.
 -r, --room-number ROOM     Change the room number of the account.
 -V, --version              Show version information and exit.
 -w, --work-phone WORK      Change the work phone number of the account.
     --dry-run              Dump LDIF and exit.

Operands:
 USER             The username (the user identifier defined by the uid
                  attribute) or the distinguished name (DN) of the LDAP user
                  account which is to be modified using administrative
                  privileges.
                  The default is to modify the LDAP user account of the current
                  user using user privileges.

Environment:
 LDAPBINDDN       A distinguished name (DN) to be used for binding to an LDAP
                  server. The default is to search for a distinguished name
                  (DN) based on the current real username.
 LDAPBINDPW       A password for the distinguished name (DN) to be used for
                  binding to an LDAP server. The default is to prompt for
                  a password.
 LDAPCONF         A system LDAP configuration file.
 LDAPRC           A user LDAP configuration file.
 LDAPURI          An URI of an LDAP server or a list of URIs of LDAP servers.
 LDAPMODIFY_OPTS  Options for ldapmodify(1).
 LDAPSEARCH_OPTS  Options for ldapsearch(1).
 LOGNAME          A username.
 SUDO_USER        A real username.
 USER             A fallback username.

Files:
 /etc/ldap/ldap.conf  LDAP configuration. See also ldap.conf(5).

__USAGE__
--version ) unset LDAP_HAS_FRONTEND ;;
esac
${LDAP_HAS_FRONTEND:+:} exec "${0%ldap-*}ldap-passwd" --mode=frontend "${0}" "${@}"

###########################################################################
#
# Defaults.
#
###########################################################################
LOGNAME=${LOGNAME-${USER-$( id -un )}}
unset USER_COMMENT
unset USER_HOME_PHONE USER_MOBILE_PHONE USER_ROOM_NUMBER USER_WORK_PHONE

###########################################################################
#
# Options.
#
###########################################################################
while getopts f:h:m:r:Vw:-: OPT "${@}"
do
	case -${OPT}${OPTARG-} in
	--full-name    | \
	--home-phone   | \
	--mobile-phone | \
	--room-number  | \
	--work-phone   )
		OPT=${OPT}${OPTARG}
		eval 'OPTARG=${'"${OPTIND}"'?}'
		OPTIND=$(( ${OPTIND} + 1 ))
		;;
	--*=* ) OPT=${OPT}${OPTARG%%=*} OPTARG=${OPTARG#*=} ;;
	--*   ) OPT=${OPT}${OPTARG%%=*} OPTARG= ;;
	esac
	case -${OPT} in
	--full-name    | -f ) USER_COMMENT=${OPTARG} ;;
	--help              ) exec "${0}" --help"${OPTARG+=${OPTARG}}" >&3 ;;
	--home-phone   | -h ) USER_HOME_PHONE=${OPTARG} ;;
	--mobile-phone | -m ) USER_MOBILE_PHONE=${OPTARG} ;;
	--room-number  | -r ) USER_ROOM_NUMBER=${OPTARG} ;;
	--version      | -V ) exec "${0}" --version >&3 ;;
	--work-phone   | -w ) USER_WORK_PHONE=${OPTARG} ;;
	--dry-run      ) exec >&3 ;;
	--*            ) OPTIND=1; getopts '' OPT "-${OPT}"; exit ;;
	*              ) exit 1 ;;
	esac
done
shift $(( $OPTIND - 1 ))
USER=${1-${LOGNAME}}
: "${USER:?}"

###########################################################################
#
# Values.
#
###########################################################################
# USER_DN.
case ${USER} in
*=* ) USER_DN=${USER} ;;
*   ) USER_DN=$(
	ldapsearch -LLLM ${LDAPSEARCH_OPTS} -z 1 -- \
		"(&(objectClass=posixAccount)(uid=${USER}))" 1.1 2> /dev/null \
	| unfold \
	| sed -e '/^dn: */!d' -e 's///' -e 'q'
	) ;;
esac
: "${USER_DN:?}"

# LDAPBINDDN.
case ${1++} in
+ ) LDAPBINDDN=${LDAPBINDDN-$(
	printf '%s\n' "${SUDO_USER-${LOGNAME}}" 'admin' \
	| ldapsearch -LLLM ${LDAPSEARCH_OPTS} -f - -z 1 -- \
		"(&(objectClass=simpleSecurityObject)(cn=%s))" 1.1 \
		2> /dev/null \
	| unfold \
	| sed -e '/^dn: */!d' -e 's///' -e 'q'
	)} ;;
* ) LDAPBINDDN=${USER_DN} ;;
esac
case ${LDAPBINDDN:++} in
+ ) export LDAPBINDDN; printf '# LDAPBINDDN=%s\n' "${LDAPBINDDN}" ;;
esac

# USER_COMMENT, USER_HOME_PHONE, USER_MOBILE_PHONE, USER_ROOM_NUMBER, USER_WORK_PHONE.
case ${USER_COMMENT++}${USER_HOME_PHONE++}${USER_MOBILE_PHONE++}${USER_ROOM_NUMBER++}${USER_WORK_PHONE++} in
'' )
	gettext_fallback() { # -d <DEFAULT-DOMAIN> [OPTION]... <MSGID>
		eval "msgid=\${${#}}"
		msgstr=$( gettext "${@}" )
		case ${msgstr} in "${msgid}" )
			shift 2 # -d <DEFAULT-DOMAIN>
			for basename in $(
				exec 2> /dev/null
				set +f
				lang=${LC_ALL:-${LC_MESSAGES:-${LANG:--}}}
				cd -- /usr/share/locale/${lang%%[_.@]*}*/LC_MESSAGES
				grep -Flxz -e "${msgid}" -- *.mo
				)
			do
				msgstr=$( gettext -d "${basename%.*}" "${@}" )
				case ${msgstr} in "${msgid}" ) ;; *) break ;; esac
			done
		esac
		printf '%s' "${msgstr}"
	}
	printf "$( gettext -d shadow -- 'Changing the user information for %s
' )\\n" "${USER}" >&2
	gettext -d shadow -s -- 'Enter the new value, or press ENTER for the default' >&2
	while read variable attribute label <&4
	do
		value=$(
			ldapsearch -LLLM ${LDAPSEARCH_OPTS} -b "${USER_DN}" -s base -z 1 -- \
				'(objectClass=*)' "${attribute}" 2> /dev/null \
			| unfold \
			| sed -e '/^dn:/d' -e '/./!d' \
			| while IFS=':' read attribute value
			do
				case ${value} in
				( ': '* ) value=$(
					printf '%s\n' "${value#": "}" \
					| base64 -d
					) ;;
				( ' '* ) value=${value#" "} ;;
				esac
				printf '%s\n' "${value}"
			done
			)
		printf '\t%s [%s]: ' "$( gettext_fallback -d shadow -- "${label}" )" "${value}" >&2
		IFS= read -r REPLY
		case ${REPLY} in
		*[![:space:]]* ) eval "USER_${variable}"='${REPLY}' ;;
		[[:space:]]*   ) eval "USER_${variable}"= ;;
		esac
	done 4<< __INFO__
		COMMENT		cn		Full Name
		ROOM_NUMBER	roomNumber	Room Number
		WORK_PHONE	telephoneNumber	Work Phone
		HOME_PHONE	homePhone	Home Phone
		MOBILE_PHONE	mobile		Mobile Phone
__INFO__
	;;
esac

###########################################################################
#
# LDIF.
#
###########################################################################
# USER_COMMENT, USER_HOME_PHONE, USER_MOBILE_PHONE, USER_ROOM_NUMBER, USER_WORK_PHONE.
case ${USER_COMMENT++}${USER_HOME_PHONE++}${USER_MOBILE_PHONE++}${USER_ROOM_NUMBER++}${USER_WORK_PHONE++} in
+* ) cat << __LDIF__ ;;
dn: ${USER_DN}
changetype: modify${USER_COMMENT+
replace: cn
cn: ${USER_COMMENT:-${USER}}
-}${USER_HOME_PHONE+
replace: homePhone${USER_HOME_PHONE:+
homePhone: ${USER_HOME_PHONE}}
-}${USER_MOBILE_PHONE+
replace: mobile${USER_MOBILE_PHONE:+
mobile: ${USER_MOBILE_PHONE}}
-}${USER_ROOM_NUMBER+
replace: roomNumber${USER_ROOM_NUMBER:+
roomNumber: ${USER_ROOM_NUMBER}}
-}${USER_WORK_PHONE+
replace: telephoneNumber${USER_WORK_PHONE:+
telephoneNumber: ${USER_WORK_PHONE}}
-}

__LDIF__
esac
