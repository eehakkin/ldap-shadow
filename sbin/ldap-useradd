#! /bin/sh -Cefu
###########################################################################
# ldap-useradd 1.0
#
# Copyright (C) 2012 Eero Häkkinen <Eero+ldap-shadow@Häkkinen.fi>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
###########################################################################
unfold() { exec sed -e ': in' -e 'N' -e 's/\n //' -e 't in' -e 'P' -e 'D'; }
case ${1-} in
--help ) exec cat << __USAGE__ ;;
Usage: ${0##*[\\/]} [OPTION]... USER

Options:
 -b, --base-dir BASE_DIR       Use the base directory for home directories.
 -c, --comment COMMENT         Use the full name for the new account.
 -d, --home-dir HOME_DIR       Use the home directory for the new account.
 -e, --expiredate EXPIRE_DATE  Use the expiration date for the new account.
 -f, --inactive INACTIVE       Use the password inactivity period.
 -g, --gid GID                 Use the primary group ID for the new account.
 -G, --groups GROUPS           Use the secondary groups for the new account.
 -h, --help                    Display this help message and exit.
 -K, --key KEY=VALUE           Override a default configuration.
 -M, --no-create-home          (ignored)
 -N, --no-user-group           Do not create a group with the same name.
 -o, --non-unique              (ignored)
 -r, --system                  Create a system user.
 -s, --shell SHELL             Use the login shell for the new account.
 -u, --uid UID                 Use the user ID for the new account.
 -U, --user-group              Create a group with the same name.
     --dump-ldif               Dump LDIF and exit.

Operands:
 USER             A username of the user whose account is to be modified using
                  administration privileges.

Configuration variables:
 GID_MIN          A minimum group ID for a new user group.
 GID_MAX          A maximum group ID for a new user group.
 GROUP_BASE_DN    A distinguished name (DN) to be used as a base DN while
                  constructing a new user group DN.
 GROUP_OU         An organization unit name to be used while constructing
                  a new user group DN.
 UID_MIN          A minimum user ID for a new account.
 UID_MAX          A maximum user ID for a new account.
 USER_BASE_DN     A distinguished name (DN) to be used as a base DN while
                  constructing a new user DN.
 USER_OU          An organization unit name to be used while constructing
                  a new user DN.

Environment:
 LDAPBINDDN       A distinguished name (DN) to be used for binding to an LDAP
                  server. The default is to search for an distinguished name
                  (DN) based on the current real username.
 LDAPBINDPW       A password for the distinguished name (DN) to be used for
                  binding to an LDAP server. The default is to prompt for
                  a password.
 LDAPCONF         A system LDAP configuration file.
 LDAPRC           A user LDAP configuration file.
 LDAPURI          An URI of an LDAP server or a list of URIs of LDAP servers.
 LDAPMODIFY_OPTS  Options for ldapmodify(1).
 LDAPSEARCH_OPTS  Options for ldapsearch(1).
 LOGNAME          A username.
 SUDO_USER        A real username.
 USER             A fallback username.

__USAGE__
--mode=* )
	me=$( which -- "${0}" || ls -d -- "${0}" )
	dir=$( dirname -- "${me}" )
	base=$( basename -- "${me}" )
	exec "${dir}/../bin/${base%ldap-*}ldap-passwd" "${@}"
	;;
esac
${LDAP_HAS_FRONTEND:+:} exec "${0%ldap-*}ldap-useradd" --mode=frontend "${0}" "${@}"

###########################################################################
#
# Defaults.
#
###########################################################################
GID_MIN=10000 GID_MAX=19999
UID_MIN=10000 UID_MAX=19999
NORMAL=+ SYSTEM= USER_GROUP=+
unset GROUP_BASE_DN GROUP_OU
unset USER_BASE_DN  USER_OU
unset USER_COMMENT USER_GID USER_GROUPS USER_HOME_DIR USER_UID
unset USER_EXPIRE USER_INACTIVE
BASE_DIR=/home/users USER_SHELL=/bin/bash

###########################################################################
#
# Options.
#
###########################################################################
while getopts b:c:d:e:f:g:G:hK:MNors:u:U-: OPT "${@}"
do
	case -${OPT}${OPTARG-} in
	--base-dir   | \
	--comment    | \
	--home       | \
	--home-dir   | \
	--expiredate | \
	--inactive   | \
	--gid        | \
	--groups     | \
	--key        | \
	--shell      | \
	--uid        )
		OPT=${OPT}${OPTARG}
		eval 'OPTARG=${'"${OPTIND}"'?}'
		OPTIND=$(( ${OPTIND} + 1 ))
		;;
	--*=* ) OPT=${OPT}${OPTARG%%=*} OPTARG=${OPTARG#*=} ;;
	--*   ) OPT=${OPT}${OPTARG%%=*} OPTARG= ;;
	esac
	case -${OPT} in
	--base-dir       | -b ) BASE_DIR=${OPTARG} ;;
	--comment        | -c ) USER_COMMENT=${OPTARG} ;;
	--home           |    \
	--home-dir       | -d ) USER_HOME_DIR=${OPTARG} ;;
	--expiredate     | -e )
		USER_EXPIRE=${OPTARG}
		case ${USER_EXPIRE} in *[![:digit:]]* )
			USER_EXPIRE=$( date -d "${USER_EXPIRE} UTC" +'%s' )
			USER_EXPIRE=$(( ${USER_EXPIRE} / ( 24 * 60 * 60 ) ))
		esac
		;;
	--inactive       | -f ) USER_INACTIVE=${OPTARG} ;;
	--gid            | -g ) USER_GID=${OPTARG} ;;
	--groups         | -G ) USER_GROUPS=${OPTARG} ;;
	--help           | -h ) exec "${0}" --help >&3 ;;
	--key            | -K ) eval "${OPTARG%%=*}"='${OPTARG#*=}' ;;
	--no-log-init    | -l ) ;;
	--no-create-home | -M ) ;;
	--no-user-group  | -N ) USER_GROUP= ;;
	--non-unique     | -o ) ;;
	--system         | -r ) NORMAL= SYSTEM=+ ;;
	--shell          | -s ) USER_SHELL=${OPTARG} ;;
	--uid            | -u ) USER_UID=${OPTARG} ;;
	--user-group     | -U ) USER_GROUP=+ ;;
	--dump-ldif      ) exec >&3 ;;
	--*              ) OPTIND=1; getopts '' OPT "-${OPT}"; exit 1 ;;
	*                ) exit 1 ;;
	esac
done
shift $(( $OPTIND - 1 ))
USER=${1-}
: "${USER:?}"

# LDAPBINDDN.
LDAPBINDDN=${LDAPBINDDN-$(
	printf '%s\n' "${SUDO_USER-${LOGNAME}}" 'admin' \
	| ldapsearch -LLLM ${LDAPSEARCH_OPTS} -f - -z 1 -- \
		"(&(objectClass=simpleSecurityObject)(cn=%s))" 1.1 \
		2> /dev/null \
	| unfold \
	| sed -e '/^dn: */!d' -e 's///' -e 'q'
	)}
case ${LDAPBINDDN:++} in
+ ) export LDAPBINDDN; printf '# LDAPBINDDN=%s\n' "${LDAPBINDDN}" ;;
esac

###########################################################################
#
# Values.
#
###########################################################################
# USER_GID.
case ${USER_GID-},${USER_GROUP:++} in
,  ) USER_GID=100 ;;
,+ )
	USER_GID=$(
		ldapsearch -LLLM ${LDAPSEARCH_OPTS} -z 1 -- \
			"(&(objectClass=posixGroup)(cn=${USER}))"	\
			gidNumber					\
			2> /dev/null					\
		| unfold \
		| sed -e '/^gidNumber: /!d' -e 's///' -e 'q'
		)
	case ${USER_GID} in
	'' )
		set -- \
			${GID_MIN:+       -K "GID_MIN=${GID_MIN}"             }	\
			${GID_MAX:+       -K "GID_MAX=${GID_MAX}"             }	\
			${GROUP_BASE_DN:+ -K "GROUP_BASE_DN=${GROUP_BASE_DN}" }	\
			${GROUP_OU:+      -K "GROUP_OU=${GROUP_OU}"           }	\
			--							\
			"${USER}"
		. "${0%ldap-*}ldap-groupadd"
		USER_GID=${GROUP_GID:?}
		;;
	esac
	;;
*[![:digit:]]*,* )
	USER_GID=$( getent -- group "${USER_GID}" | cut -d : -f 3 )
	;;
esac
: "${USER_GID:?}"

# USER_BASE_DN.
USER_BASE_DN=${USER_BASE_DN-$(
	ldapsearch -LLLM ${LDAPSEARCH_OPTS} \
		${base_dn:+ -b "${base_dn}" } -z 1 -- \
		"(objectClass=posixAccount)" 1.1 2> /dev/null \
	| unfold \
	| sed -e '/^dn: [^\n]*,\(ou=[^\n]*\)$/!d' -e 's//\1/' -e 'q'
	)}
: "${USER_BASE_DN:?}"

# USER_COMMENT.
USER_COMMENT=${USER_COMMENT:-${USER}}
: "${USER_COMMENT:?}"

# USER_HOME_DIR.
USER_HOME_DIR=${USER_HOME_DIR:-${BASE_DIR:?}/${USER}}
: "${USER_HOME_DIR:?}"

# USER_OU.
while :
do
	###################################################################
	#
	# LDIF.
	#
	###################################################################
	# USER_OU.
	case ${USER_OU++}${USER_OU:++} in
	'' ) RDN=ou=${USER%-*} ;;
	+  ) break ;;
	++ ) RDN=${USER_OU##*,} ;;
	esac
	ldapsearch -LLLM ${LDAPSEARCH_OPTS} -b "${RDN},${USER_BASE_DN}" -s base -- \
		'(objectClass=*)' 1.1 1> /dev/null 2>&1 && :
	case ${?},${USER},${USER_OU:++} in
	0,*,*  ) ;;
	*,*,+  | \
	*,*-*, ) cat << __LDIF__ ;;
dn: ${RDN},${USER_BASE_DN}
changetype: add
objectClass: organizationalUnit
${RDN%%=*}: ${RDN#*=}

__LDIF__
	*,*,*  ) break ;;
	esac
	###################################################################
	#
	# Values.
	#
	###################################################################
	# USER_BASE_DN.
	USER_BASE_DN=${RDN},${USER_BASE_DN}
	case ${USER_OU-} in
	*,* ) USER_OU=${USER_OU%,*} ;;
	*   ) break ;;
	esac
done

# USER_UID.
USER_UID=${USER_UID:-$(
	ldapsearch -LLLM ${LDAPSEARCH_OPTS} -- \
		"(objectClass=posixAccount)" uidNumber \
	| unfold \
	| awk -F ': ' -v min="${UID_MIN:?}" -v max="${UID_MAX:?}" '
$1 != "uidNumber" { next }
$2 == min { ++min; while ( used[min] ) delete used[min++] }
min < $2 && $2 <= max { used[$2] = 1 }
END { if ( min <= max ) print min }
'
	)}
: "${USER_UID:?}"

# USER_DN.
USER_DN=uid=${USER},${USER_BASE_DN}

###########################################################################
#
# LDIF.
#
###########################################################################
# USER.
cat << __LDIF__
dn: ${USER_DN}
changetype: add
objectClass: posixAccount
objectClass: shadowAccount${NORMAL:+
objectClass: inetOrgPerson}${SYSTEM:+
objectClass: organizationalRole}
cn: ${USER_COMMENT}
gidNumber: ${USER_GID}${NORMAL:+
givenName: ${USER_COMMENT%%[[:space:]]*}}
homeDirectory: ${USER_HOME_DIR}
loginShell: ${USER_SHELL}${USER_EXPIRE+
shadowExpire: ${USER_EXPIRE}}${USER_INACTIVE+
shadowInactive: ${USER_INACTIVE}}${NORMAL:+
sn: ${USER_COMMENT#*[[:space:]]}}
uidNumber: ${USER_UID}

__LDIF__

# USER_GROUPS.
case ${USER_GROUPS:++} in
+ ) set -- -a -G "${USER_GROUPS}" -- "${USER}"; . "${0%ldap-*}ldap-usermod" ;;
esac
